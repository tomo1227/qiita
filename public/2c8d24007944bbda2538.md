---
title: ã€Goè¨€èªã€‘ãƒ¢ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ãŸãƒ†ã‚¹ãƒˆ
tags:
  - Go
private: false
updated_at: '2024-07-07T23:01:23+09:00'
id: 2c8d24007944bbda2538
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«

Goã®ãƒ¢ãƒƒã‚¯ã®ä»•æ–¹ã‚’å­¦ã¶ãŸã‚ã«ã€ä»¥ä¸‹2ã¤ã®æ–¹æ³•ã‚’è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

* [ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãªã„ãƒ¢ãƒƒã‚¯](#ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãªã„ãƒ¢ãƒƒã‚¯)
* [gomockã‚’ä½¿ç”¨ã—ãŸãƒ¢ãƒƒã‚¯](#gomock)

# ãƒ†ã‚¹ãƒˆå¯¾è±¡

ä»Šå›ã¯ã€ä»¥ä¸‹ã®**foo.go**ã®`Fly()`ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

```foo.go
type FourDimensionalPocket interface {
 GetTakecopter() (string, error)
 GetDokodemodoa() (string, error)
}

type Doraemon struct {
}

func (d Doraemon) GetTakecopter() (string, error) {
 return "ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸš", nil
}

func (d Doraemon) GetDokodemodoa() (string, error) {
 return "ã©ã“ã§ã‚‚ãƒ‰ã‚¢ğŸšª", nil
}

func NewDoraemon() Doraemon {
 return Doraemon{}
}

type Nobita struct {
 pocket FourDimensionalPocket
}

type Bird interface {
 Fly() string
}

func NewNobita(pocket FourDimensionalPocket) Bird {
 return Nobita{
  pocket: pocket,
 }
}

func (n Nobita) Fly() string {
 takecopter, err := n.pocket.GetTakecopter()
 if err != nil {
  return "é£›ã¹ã¾ã›ã‚“ğŸ§"
 }
 return fmt.Sprintf("%sã‚’ä½¿ã£ã¦é£›ã‚“ã§ã„ã!", takecopter)
}
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

```go
func main() {
 doraemon := NewDoraemon()
 nobita := NewNobita(doraemon)
 result := nobita.fly()
 fmt.Println(result) // ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸšã‚’ä½¿ã£ã¦é£›ã‚“ã§ã„ã!
}
```

ã“ã®Flyã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãšå®Ÿè£…ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãªã„ãƒ¢ãƒƒã‚¯

```go:foo_test.go
package foo_test

import (
 "testing"

 "foo"

 "github.com/stretchr/testify/assert"
)

type mockDoraemon struct {
 errFunc string
}

func newMockDoraemon(errFunc string) *mockDoraemon {
 return &mockDoraemon{errFunc: errFunc}
}

func (d *mockDoraemon) GetTakecopter() (string, error) {
 if d.errFunc == "GetTakecopter" {
  return "", assert.AnError
 }
 return "ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸš", nil
}

func (d *mockDoraemon) GetDokodemodoa() (string, error) {
 if d.errFunc == "GetDokodemodoa" {
  return "", assert.AnError
 }
 return "ã©ã“ã§ã‚‚ãƒ‰ã‚¢ğŸšª", nil
}

func TestNobita_fly(t *testing.T) {
 tests := []struct {
  name    string
  want    string
  errFunc string
 }{
  {
   name:    "Success Test",
   want:    "ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸšã‚’ä½¿ã£ã¦é£›ã‚“ã§ã„ã!",
   errFunc: "",
  },
  {
   name:    "Fail Test",
   want:    "é£›ã¹ã¾ã›ã‚“ğŸ§",
   errFunc: "GetTakecopter",
  },
 }
 for _, tt := range tests {
  t.Run(tt.name, func(t *testing.T) {

   doraemon := newMockDoraemon(tt.errFunc)
   nobita := foo.NewNobita(doraemon)
   if got := nobita.Fly(); got != tt.want {
    t.Errorf("Nobita.Fly() = %v, want %v", got, tt.want)
   }

  })
 }
}
```

ã“ã“ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«newMockDoraemonã¨å®Ÿä½“ã‚’ä½œæˆã—ã¦ãŠã‚Šã¾ã™ãŒã€

```go
func newMockDoraemon(errFunc string) *mockDoraemon {
 return &mockDoraemon{errFunc: errFunc}
}
```

å®Ÿéš›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æŠ½è±¡ã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ã–ã‚ã–å®Ÿä½“ã‚’ä½œã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```go
func NewNobita(pocket FourDimensionalPocket) Bird {
 return Nobita{
  pocket: pocket,
 }
}
```

ã‚†ãˆã«ã€å…ˆã»ã©ã®ãƒ†ã‚¹ãƒˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚‚ã‹ã‘ã¾ã™ã€‚

# gomock

https://github.com/uber-go/mock

gomockã¨ã¯GoogleãŒé–‹ç™ºã—ãŸãƒ¢ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚Googleã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€public archiveã•ã‚Œã¦ãŠã‚Šã€ç¾åœ¨ã¯UberãŒforkã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ã€‚

å¤ã„ãƒªãƒã‚¸ãƒˆãƒª : https://github.com/golang/mock

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
go install go.uber.org/mock/mockgen@latest
```

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

```sh
$ mockgen -version
v0.4.0
```

## ãƒ¢ãƒƒã‚¯è‡ªå‹•ç”Ÿæˆ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚

```sh
mockgen -source=***.go
```

å…ˆã»ã©ã®`foo.go`ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚ŠãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```sh
mockgen -source=foo.go -destination=mock/mock_foo.go -exclude_interfaces=Bird
```

å‡ºåŠ›å…ˆã‚’`mock/mock_foo.go`ã«æŒ‡å®šã—ã¦ã€`Bird`ã®interfaceã¯ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ãªã„ã®ã§ã€ä»Šå›ã¯é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆã—ãŸ`mock_foo.go`ã§ã™ã€‚é•·ã„ã®ã§æŠ˜ã‚ŠãŸãŸã¿ã¾ã—ãŸã€‚

<details><summary> mock/mock_foo.go </summary>

```go:mock/mock_foo.go
// Code generated by MockGen. DO NOT EDIT.
// Source: foo.go
//
// Generated by this command:
//
// mockgen -source=foo.go -destination=mock/mock_foo.go
//

// Package mock_foo is a generated GoMock package.
package mock_foo

import (
 reflect "reflect"

 gomock "go.uber.org/mock/gomock"
)

// MockFourDimensionalPocket is a mock of FourDimensionalPocket interface.
type MockFourDimensionalPocket struct {
 ctrl     *gomock.Controller
 recorder *MockFourDimensionalPocketMockRecorder
}

// MockFourDimensionalPocketMockRecorder is the mock recorder for MockFourDimensionalPocket.
type MockFourDimensionalPocketMockRecorder struct {
 mock *MockFourDimensionalPocket
}

// NewMockFourDimensionalPocket creates a new mock instance.
func NewMockFourDimensionalPocket(ctrl *gomock.Controller) *MockFourDimensionalPocket {
 mock := &MockFourDimensionalPocket{ctrl: ctrl}
 mock.recorder = &MockFourDimensionalPocketMockRecorder{mock}
 return mock
}

// EXPECT returns an object that allows the caller to indicate expected use.
func (m *MockFourDimensionalPocket) EXPECT() *MockFourDimensionalPocketMockRecorder {
 return m.recorder
}

// GetDokodemodoa mocks base method.
func (m *MockFourDimensionalPocket) GetDokodemodoa() (string, error) {
 m.ctrl.T.Helper()
 ret := m.ctrl.Call(m, "GetDokodemodoa")
 ret0, _ := ret[0].(string)
 ret1, _ := ret[1].(error)
 return ret0, ret1
}

// GetDokodemodoa indicates an expected call of GetDokodemodoa.
func (mr *MockFourDimensionalPocketMockRecorder) GetDokodemodoa() *gomock.Call {
 mr.mock.ctrl.T.Helper()
 return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "GetDokodemodoa", reflect.TypeOf((*MockFourDimensionalPocket)(nil).GetDokodemodoa))
}

// GetTakecopter mocks base method.
func (m *MockFourDimensionalPocket) GetTakecopter() (string, error) {
 m.ctrl.T.Helper()
 ret := m.ctrl.Call(m, "GetTakecopter")
 ret0, _ := ret[0].(string)
 ret1, _ := ret[1].(error)
 return ret0, ret1
}

// GetTakecopter indicates an expected call of GetTakecopter.
func (mr *MockFourDimensionalPocketMockRecorder) GetTakecopter() *gomock.Call {
 mr.mock.ctrl.T.Helper()
 return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "GetTakecopter", reflect.TypeOf((*MockFourDimensionalPocket)(nil).GetTakecopter))
}

// MockBird is a mock of Bird interface.
type MockBird struct {
 ctrl     *gomock.Controller
 recorder *MockBirdMockRecorder
}

// MockBirdMockRecorder is the mock recorder for MockBird.
type MockBirdMockRecorder struct {
 mock *MockBird
}

// NewMockBird creates a new mock instance.
func NewMockBird(ctrl *gomock.Controller) *MockBird {
 mock := &MockBird{ctrl: ctrl}
 mock.recorder = &MockBirdMockRecorder{mock}
 return mock
}

// EXPECT returns an object that allows the caller to indicate expected use.
func (m *MockBird) EXPECT() *MockBirdMockRecorder {
 return m.recorder
}

// Fly mocks base method.
func (m *MockBird) Fly() string {
 m.ctrl.T.Helper()
 ret := m.ctrl.Call(m, "Fly")
 ret0, _ := ret[0].(string)
 return ret0
}

// Fly indicates an expected call of Fly.
func (mr *MockBirdMockRecorder) Fly() *gomock.Call {
 mr.mock.ctrl.T.Helper()
 return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "Fly", reflect.TypeOf((*MockBird)(nil).Fly))
}
```

</details>

ãƒ†ã‚¹ãƒˆè‡ªä½“ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go
package foo_test

import (
 "testing"

 "foo"
 mock_foo "foo/mock"
 "github.com/stretchr/testify/assert"
 gomock "go.uber.org/mock/gomock"
)

func TestNobitaFly(t *testing.T) {
 ctrl := gomock.NewController(t)
 defer ctrl.Finish()

 mockPocket := mock_foo.NewMockFourDimensionalPocket(ctrl)

 tests := []struct {
  name        string
  mockReturn  string
  mockError   error
  expectedFly string
 }{
  {
   name:        "æ­£å¸¸ãªã‚±ãƒ¼ã‚¹",
   mockReturn:  "ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸš",
   mockError:   nil,
   expectedFly: "ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼ğŸšã‚’ä½¿ã£ã¦é£›ã‚“ã§ã„ã!",
  },
  {
   name:        "ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹",
   mockReturn:  "",
   mockError:   assert.AnError,
   expectedFly: "é£›ã¹ã¾ã›ã‚“ğŸ§",
  },
 }

 for _, tt := range tests {
  t.Run(tt.name, func(t *testing.T) {
   mockPocket.EXPECT().GetTakecopter().Return(tt.mockReturn, tt.mockError).Times(1)
   nobita := foo.NewNobita(mockPocket)
   assert.Equal(t, tt.expectedFly, nobita.Fly())
  })
 }
}
```

# gomock v.s. pureãªmock

ãƒ¢ãƒƒã‚¯ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¢—ãˆã‚‹ã¨ã€gomockã‚’ä½¿ã£ãŸæ–¹ãŒæ¥½ãã†ã§ã™ã€‚(æŠ½è±¡åº¦ãŒé©åˆ‡ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ãŒ)
è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹ã‹gomockã‚’ä½¿ã†ã‹ã¯å¥½ã¿ã«ãªã‚‹ã¨æ€ã†ã®ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è©±ã—åˆã£ã¦æ±ºã‚ã¦ãã ã•ã„ã€‚

# ãã®ä»–ã®ãƒ¢ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã»ã‹ã«ã‚‚ã‚ã‚‹ãŒã€moqã¯ã‚¹ã‚¿ãƒ–ã‚’ä½œã‚‹ã ã‘ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‰ã—ã„ã€‚(å‚è€ƒ :[gomock ã¨æ¯”è¼ƒã•ã‚Œã‚‹ moqï¼Œã“ã„ã¤ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã˜ã‚ƒãªãã¦ã‚¹ã‚¿ãƒ–ã‚’ä½œã‚‹ã ã‘ã®è²¬å‹™æ”¾æ£„ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ï¼](https://zenn.dev/mpyw/scraps/feffc9b3760000))

* https://github.com/vektra/mockery
* https://github.com/matryer/moq
